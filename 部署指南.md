# 零材料批发货物追踪系统部署指南

## 1. 系统架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                    微信客户端                              │
└─────────────────────┬───────────────────────────────────────┘
                      │  HTTPS
┌─────────────────────┴───────────────────────────────────────┐
│                  微信小程序前端                           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │  登录授权   │ │ 订单查询    │ │ 消息中心    │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────┬───────────────────────────────────────┘
                      │  REST API
┌─────────────────────┴───────────────────────────────────────┐
│                  Flask后端服务                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │  用户认证   │ │ 订单管理    │ │ 消息推送    │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │ ERP集成    │ │ 系统监控    │ │ 日志管理    │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────┬───────────────────────────────────────┘
                      │  MySQL 5.7
┌─────────────────────┴───────────────────────────────────────┐
│                    数据库层                               │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │ 用户会话   │ │ 企业绑定    │ │ 消息记录    │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

## 2. 环境要求

### 2.1 服务器要求
- **操作系统**: Ubuntu 18.04 LTS 或 CentOS 7+
- **CPU**: 2核以上
- **内存**: 4GB以上
- **硬盘**: 50GB以上
- **网络**: 公网IP，开放80/443端口

### 2.2 软件环境
- **Python**: 3.8+
- **MySQL**: 5.7+
- **Nginx**: 1.18+
- **Redis**: 6.0+ (可选，用于缓存)
- **Git**: 2.20+

## 3. 后端部署步骤

### 3.1 环境准备
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Python 3.8
sudo apt install python3.8 python3.8-venv python3.8-dev -y

# 安装MySQL
sudo apt install mysql-server-5.7 -y

# 安装Nginx
sudo apt install nginx -y

# 安装其他依赖
sudo apt install git supervisor redis-server -y
```

### 3.2 数据库配置
```bash
# 登录MySQL
mysql -u root -p

# 创建数据库
CREATE DATABASE goods_tracking CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建用户并授权
CREATE USER 'tracking_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON goods_tracking.* TO 'tracking_user'@'localhost';
FLUSH PRIVILEGES;

# 退出MySQL
exit
```

### 3.3 后端代码部署
```bash
# 创建应用目录
sudo mkdir -p /opt/goods-tracking
sudo chown $USER:$USER /opt/goods-tracking

# 进入目录
cd /opt/goods-tracking

# 克隆代码（假设代码已上传到Git仓库）
git clone https://github.com/your-repo/goods-tracking-backend.git .

# 创建虚拟环境
python3.8 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 配置环境变量
cp .env.example .env
nano .env
```

### 3.4 环境变量配置
```bash
# 编辑.env文件，配置以下参数
DATABASE_URL=mysql://tracking_user:your_secure_password@localhost/goods_tracking
SECRET_KEY=your_very_secret_key_here
WECHAT_APP_ID=your_wechat_app_id
WECHAT_APP_SECRET=your_wechat_app_secret
WECHAT_TOKEN=your_wechat_token
ERP_API_BASE_URL=https://your-erp-api.com
ERP_API_KEY=your_erp_api_key
LOG_LEVEL=INFO
REDIS_URL=redis://localhost:6379/0
```

### 3.5 数据库初始化
```bash
# 激活虚拟环境
source venv/bin/activate

# 运行数据库迁移
python manage.py db init
python manage.py db migrate -m "Initial migration"
python manage.py db upgrade

# 创建管理员用户（如果需要）
python manage.py create-admin
```

### 3.6 启动服务
```bash
# 开发环境启动
python manage.py run

# 生产环境启动（使用gunicorn）
gunicorn -w 4 -b 0.0.0.0:8000 --timeout 120 --keep-alive 2 \
  --access-logfile /var/log/goods-tracking/access.log \
  --error-logfile /var/log/goods-tracking/error.log \
  --capture-output \
  --logger-class simple \
  app:app
```

## 4. Nginx配置

### 4.1 创建Nginx配置文件
```bash
sudo nano /etc/nginx/sites-available/goods-tracking
```

### 4.2 配置内容
```nginx
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL证书配置
    ssl_certificate /etc/ssl/certs/your-domain.com.crt;
    ssl_certificate_key /etc/ssl/private/your-domain.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # 安全头配置
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self' https: data: 'unsafe-inline'" always;

    # 日志配置
    access_log /var/log/nginx/goods-tracking.access.log;
    error_log /var/log/nginx/goods-tracking.error.log;

    # 文件上传限制
    client_max_body_size 10M;

    # API代理配置
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # 静态文件配置（如果有）
    location /static/ {
        alias /opt/goods-tracking/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 健康检查
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

### 4.3 启用配置
```bash
# 创建符号链接
sudo ln -s /etc/nginx/sites-available/goods-tracking /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

## 5. 微信小程序部署

### 5.1 配置小程序
```javascript
// miniprogram/app.ts
App<IAppOption>({
  globalData: {
    apiBaseUrl: 'https://your-domain.com', // 替换为你的域名
    // ... 其他配置
  }
})
```

### 5.2 上传代码
1. 打开微信开发者工具
2. 点击"上传"按钮
3. 填写版本号和项目备注
4. 等待上传完成

### 5.3 提交审核
1. 登录[微信公众平台](https://mp.weixin.qq.com/)
2. 进入"版本管理"
3. 选择开发版本，点击"提交审核"
4. 填写审核信息，提交审核

## 6. 监控和日志

### 6.1 日志配置
```bash
# 创建日志目录
sudo mkdir -p /var/log/goods-tracking
sudo chown www-data:www-data /var/log/goods-tracking

# 配置日志轮转
sudo nano /etc/logrotate.d/goods-tracking
```

### 6.2 日志轮转配置
```
/var/log/goods-tracking/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
    postrotate
        systemctl reload nginx
    endscript
}
```

### 6.3 监控配置
```bash
# 安装监控工具（可选）
sudo apt install htop iotop nethogs -y

# 配置系统监控脚本
cat > /opt/goods-tracking/monitor.sh << 'EOF'
#!/bin/bash
# 系统监控脚本

# 检查服务状态
if ! systemctl is-active --quiet nginx; then
    echo "Nginx is down!" | mail -s "Server Alert" admin@your-domain.com
fi

if ! curl -f http://localhost:8000/health > /dev/null 2>&1; then
    echo "Flask app is down!" | mail -s "Server Alert" admin@your-domain.com
fi

# 检查磁盘空间
DISK_USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "Disk usage is above 80%!" | mail -s "Server Alert" admin@your-domain.com
fi
EOF

chmod +x /opt/goods-tracking/monitor.sh

# 添加到crontab
echo "*/5 * * * * /opt/goods-tracking/monitor.sh" | crontab -
```

## 7. 备份策略

### 7.1 数据库备份
```bash
# 创建备份脚本
cat > /opt/goods-tracking/backup-db.sh << 'EOF'
#!/bin/bash
# 数据库备份脚本

BACKUP_DIR="/opt/backups/database"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="goods_tracking"
DB_USER="tracking_user"

mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u $DB_USER -p$DB_PASSWORD $DB_NAME > $BACKUP_DIR/backup_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/backup_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +7 -delete
EOF

chmod +x /opt/goods-tracking/backup-db.sh

# 添加到crontab（每天凌晨2点备份）
echo "0 2 * * * /opt/goods-tracking/backup-db.sh" | crontab -
```

### 7.2 代码备份
```bash
# 创建代码备份脚本
cat > /opt/goods-tracking/backup-code.sh << 'EOF'
#!/bin/bash
# 代码备份脚本

BACKUP_DIR="/opt/backups/code"
DATE=$(date +%Y%m%d_%H%M%S)
SOURCE_DIR="/opt/goods-tracking"

mkdir -p $BACKUP_DIR

# 备份代码
tar -czf $BACKUP_DIR/code_$DATE.tar.gz -C $SOURCE_DIR . --exclude=venv --exclude=__pycache__ --exclude=*.log

# 删除30天前的备份
find $BACKUP_DIR -name "code_*.tar.gz" -mtime +30 -delete
EOF

chmod +x /opt/goods-tracking/backup-code.sh

# 添加到crontab（每周日凌晨3点备份）
echo "0 3 * * 0 /opt/goods-tracking/backup-code.sh" | crontab -
```

## 8. 安全配置

### 8.1 防火墙配置
```bash
# 安装ufw（如果未安装）
sudo apt install ufw -y

# 配置防火墙规则
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable
```

### 8.2 Fail2ban配置
```bash
# 安装fail2ban
sudo apt install fail2ban -y

# 配置fail2ban
sudo nano /etc/fail2ban/jail.local
```

### 8.3 Fail2ban配置内容
```ini
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log

[nginx-http-auth]
enabled = true
filter = nginx-http-auth
port = http,https
logpath = /var/log/nginx/error.log
maxretry = 3
```

## 9. 性能优化

### 9.1 数据库优化
```sql
-- 添加索引优化查询
ALTER TABLE user_sessions ADD INDEX idx_openid (openid);
ALTER TABLE user_sessions ADD INDEX idx_expires_at (expires_at);
ALTER TABLE erp_bindings ADD INDEX idx_openid (openid);
ALTER TABLE api_call_logs ADD INDEX idx_timestamp (timestamp);
ALTER TABLE message_logs ADD INDEX idx_openid_timestamp (openid, timestamp);
```

### 9.2 应用优化
```python
# 在配置中启用缓存
CACHE_TYPE = 'redis'
CACHE_REDIS_URL = 'redis://localhost:6379/0'
CACHE_DEFAULT_TIMEOUT = 300

# 启用连接池
SQLALCHEMY_POOL_SIZE = 20
SQLALCHEMY_POOL_TIMEOUT = 30
SQLALCHEMY_POOL_RECYCLE = 3600
```

## 10. 部署验证

### 10.1 健康检查
```bash
# 检查服务状态
curl -f http://localhost/health
curl -f http://localhost/api/health/check

# 检查数据库连接
mysql -u tracking_user -p -e "SELECT 1;"

# 检查Redis连接
redis-cli ping
```

### 10.2 功能验证
```bash
# 测试API接口
curl -X POST http://localhost/api/wechat-login \
  -H "Content-Type: application/json" \
  -d '{"code":"test_code","encryptedData":"test_data","iv":"test_iv"}'

# 测试ERP接口连接
curl -X GET "http://localhost/api/erp/status"
```

## 11. 故障排查

### 11.1 常见问题
1. **服务无法启动**
   - 检查端口是否被占用
   - 查看错误日志
   - 验证配置文件

2. **数据库连接失败**
   - 检查MySQL服务状态
   - 验证用户权限
   - 检查网络连接

3. **Nginx 502错误**
   - 检查后端服务状态
   - 查看Nginx错误日志
   - 验证代理配置

### 11.2 日志查看
```bash
# 查看应用日志
tail -f /var/log/goods-tracking/error.log

# 查看Nginx日志
tail -f /var/log/nginx/goods-tracking.error.log

# 查看系统日志
tail -f /var/log/syslog
```

## 12. 维护计划

### 12.1 日常维护
- 监控服务状态
- 检查日志文件
- 备份数据验证

### 12.2 定期维护
- 每周：检查磁盘空间
- 每月：更新系统补丁
- 每季度：性能评估和优化

---

**部署完成时间：** 预计2-3小时
**维护责任人：** 技术运维团队
**紧急联系：** ops@your-company.com
