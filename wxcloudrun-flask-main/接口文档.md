# 零材料批发货物追踪后端接口文档（Flask）

## 总览
- 基础路径：`/api`
- 响应格式统一：
  - `success`: `boolean`，是否成功
  - `message`: `string`，描述信息
  - `timestamp`: `number`，毫秒时间戳
  - `data`: `object`，业务数据（成功时返回）
- 认证方式：
  - **登录接口**：`POST /api/auth/wx-login`，返回 JWT Token。
  - **受保护接口**：Header 中携带 `Authorization: Bearer <token>`。
  - **其他说明**：后端已移除 `session_key` 存储，完全基于 JWT Token 认证。
- 速率限制（Rate Limit）：按接口声明（见各端点说明）

## 认证相关

### 微信小程序登录
- `POST /api/auth/wx-login`
- 说明：校验微信 `code`，创建/更新用户，颁发 JWT Token。
- 速率限制：`10/min`
- 请求体：
```json
{
  "code": "wx_login_code",
  "userInfo": {"nickName": "string", "avatarUrl": "string"}
}
```
- 成功响应：
```json
{
  "success": true,
  "message": "登录成功",
  "timestamp": 1734090000000,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userId": "string",
    "expiresAt": 1736682000000
  }
}
```
- 失败场景：`400 code缺失 / openid获取失败`；`500 服务错误`

### 企业绑定（通过邀请码）
- `POST /api/auth/bind-company`
- 说明：通过微信邀请码绑定企业（Snowbeasts SaaS 客户）。用户登录后若未绑定企业，需强制调用此接口。
- 认证：`Authorization: Bearer <token>`（服务端从 Token 获取 `user_id`，无需传递 `openid`）
- 速率限制：`5/min`
- 请求体：
```json
{
  "inviteCode": "string",
  "userId": "string" // 可选，若提供将与 Token 中的 user_id 一致校验
}
```
- 业务规则：
  - 邀请码允许多次使用，不做格式限制；仅校验非空
  - 服务端会校验 ERP 返回的 `微信邀请码` 与入参一致
  - 已有绑定记录时返回“已绑定该企业”，不更新绑定
- 成功响应：
```json
{
  "success": true,
  "message": "绑定成功",
  "timestamp": 1734090000000,
  "data": {
    "bindStatus": true,
    "companyInfo": {
      "companyId": "CODE001", 
      "companyName": "某某公司",
      "customerId": "123456"
    }
  }
}
```
- 失败场景：业务错误以 `200` 返回：`success=false`，比如 `邀请码无效 / 未找到对应企业 / 邀请码不匹配 / 用户不存在`；系统错误返回 `500`。

## 订单相关

### 搜索订单
- `GET /api/orders/search`
- 说明：实时查询订单列表（从 ERP 拉取）。
- 认证：`Authorization: Bearer <token>`；无需传用户标识。
- 速率限制：`30/min`
- 请求参数：
  - `keyword`: `string` 选填
  - `status`: `string` 选填（`pending|producing|shipped|completed|cancelled`）
  - `page`: `number` 默认 `1`
  - `pageSize`: `number` 默认 `20`
- 成功响应：
```json
{
  "success": true,
  "message": "查询成功",
  "timestamp": 1734090000000,
  "data": {
    "orders": [{
      "order_id": "string",
      "order_no": "string",
      "customer_name": "string",
      "order_date": "2025-12-01T12:00:00Z",
      "status": "producing",
      "materials": [{
        "material_id": "string",
        "material_code": "string",
        "status": "completed"
      }]
    }],
    "total": 100,
    "page": 1,
    "pageSize": 20,
    "queryTime": 1734090000000,
    "cacheHit": false
  }
}
```
- 失败场景：业务错误以 `200` 返回：`success=false`，比如 `未绑定企业 / 用户不存在`；认证缺失 `401`；系统错误返回 `500`。

### 获取订单状态
- `GET /api/orders/{order_id}/status`
- 认证：`Authorization: Bearer <token>`
- 速率限制：`60/min`
- 响应：`data` 为 ERP 订单状态对象（原样透传）
- 失败场景：`401 未授权/Token无效`；`500 服务器错误`

### 获取订单物料清单
- `GET /api/orders/{order_id}/materials`
- 认证：`Authorization: Bearer <token>`
- 速率限制：`60/min`
- 响应：`data` 为 ERP 物料清单对象（原样透传）
- 失败场景同上

### 获取物料生产进度
- `GET /api/materials/{material_id}/progress`
- 认证：`Authorization: Bearer <token>`
- 速率限制：`60/min`
- 响应：`data` 为 ERP 物料进度对象（原样透传）
- 失败场景同上

## 微信消息相关

### 发送订阅模板消息
- `POST /api/wechat/template-msg`
- 说明：调用微信订阅消息接口，记录发送日志
- 认证：`Authorization: Bearer <token>`；无需传用户标识。
- 速率限制：`10/min`
- 请求体：
```json
{
  "templateId": "string",
  "data": {"thing1": {"value": "..."}},
  "page": "/pages/order-detail/order-detail?orderId=..."
}
```
- 成功响应：
```json
{
  "success": true,
  "message": "消息发送成功",
  "timestamp": 1734090000000,
  "data": {"msgid": "string", "status": "sent", "sendTime": 1734090000000}
}
```
- 失败场景：业务错误以 `200` 返回：`success=false`，比如 `参数不完整 / 用户不存在`；认证缺失 `401`；系统错误返回 `500`。

## 用户相关

### 获取用户信息
- `GET /api/user/profile`
- 说明：返回企业绑定信息。
- 认证：`Authorization: Bearer <token>`；无需传用户标识。
- 速率限制：`30/min`
- 成功响应：
```json
{
  "success": true,
  "message": "查询成功",
  "timestamp": 1734090000000,
  "data": {
    "erpBinding": {
      "companyId": "string|null",
      "companyName": "string|null",
      "customerId": "string|null",
      "boundAt": 1734090000000
    },
    "sessionExpiresAt": 1736682000000
  }
}
```

## 系统监控

### 健康检查
- `GET /api/health/check`
- 说明：数据库、ERP、微信服务健康状态
- 成功响应：
```json
{
  "success": true,
  "message": "系统健康",
  "timestamp": 1734090000000,
  "data": {
    "status": "healthy",
    "timestamp": 1734090000000,
    "services": {"database": "healthy", "erp": "healthy", "wechat": "healthy"}
  }
}
```

### ERP接口状态监控
- `GET /api/erp/status`
- 说明：统计最近 1 小时各端点调用量、平均耗时、错误率/成功率
- 成功响应 `data.stats` 示例：
```json
{
  "success": true,
  "message": "查询成功",
  "timestamp": 1734090000000,
  "data": {
    "stats": [{
      "endpoint": "/api/orders/search",
      "totalCalls": 120,
      "avgResponseTime": 85.2,
      "errorRate": 1.67,
      "successRate": 98.33
    }],
    "checkTime": 1734090000000
  }
}
```

### 接口性能指标
- `GET /api/metrics/performance`
- 说明：统计最近 24 小时的按小时聚合与按端点聚合性能指标
- 成功响应：
```json
{
  "success": true,
  "message": "查询成功",
  "timestamp": 1734090000000,
  "data": {
    "hourlyStats": [{
      "hour": "2025-12-13 10:00:00",
      "totalCalls": 200,
      "avgResponseTime": 76.12,
      "maxResponseTime": 380,
      "errorCalls": 2,
      "errorRate": 1
    }],
    "endpointStats": [{
      "endpoint": "/api/orders/search",
      "totalCalls": 120,
      "avgResponseTime": 85.2,
      "maxResponseTime": 410,
      "errorCalls": 2,
      "errorRate": 1.67
    }]
  }
}
```

## 通用规则与错误码
- `openid` 校验：长度 11–99，字母数字
- Token 校验：受保护接口若 Token 无效或过期，返回 `401`
- 统一错误响应示例：
```json
{"success": false, "message": "错误描述", "timestamp": 1734090000000}
```

## 请求示例

### 使用 Authorization 头访问订单状态
```
GET /api/orders/ORD123/status
Authorization: Bearer <your_jwt_token>
```

### 搜索订单
```
GET /api/orders/search?keyword=零件&status=producing&page=1&pageSize=20
Authorization: Bearer <your_jwt_token>
```

### 绑定企业（邀请码）
```
POST /api/auth/bind-company
Authorization: Bearer <your_jwt_token>
Content-Type: application/json

{"inviteCode":"INVITE123"}
```
